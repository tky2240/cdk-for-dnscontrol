"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createReverseDnsName = createReverseDnsName;
const ipv4_1 = require("../types/ipv4");
const ipv6_1 = require("../types/ipv6");
function createReverseDnsName(cidr, reverseDomainMode) {
    if ((0, ipv6_1.isIPv6Cidr)(cidr)) {
        return generateIPv6Rfc4183ReverseDnsName(cidr);
    }
    if ((0, ipv4_1.isIPv4Cidr)(cidr)) {
        if (24 < cidr.prefixLength &&
            cidr.prefixLength < 32 &&
            reverseDomainMode == "Rfc2317") {
            return generateIPv4Rfc2317ReverseDnsName(cidr);
        }
        else {
            return generateIPv4Rfc4183ReverseDnsName(cidr);
        }
    }
    throw `Invalid cidr block, got ${cidr}`;
}
function generateIPv4Rfc2317ReverseDnsName(cidr) {
    const octets = cidr.address.split(".").map(Number);
    const lastOctet = octets[3]; // The last octet
    if (lastOctet == null) {
        throw new Error("not found last octet");
    }
    const subnetMask = 0xffffffff << cidr.prefixLength;
    const hostAddress = lastOctet & ~subnetMask; // Extract host part of last octet.
    const networkOctets = octets.slice(0, 3);
    return `${hostAddress}/${cidr.prefixLength}.${[...networkOctets].reverse().join(".")}.in-addr.arpa`;
}
function generateIPv4Rfc4183ReverseDnsName(cidr) {
    const octets = new Uint8Array(cidr.address.split(".").map(Number));
    const reverseOctets = [...octets].reverse();
    if (cidr.prefixLength < 8) {
        throw new Error("The notion of fewer than 8 mask bits is not reasonable."); // RFC 4183 4.1.4
    }
    const firstHostAddressOctetIndex = Math.trunc(cidr.prefixLength / 8);
    if (cidr.prefixLength % 8 == 0) {
        return `${reverseOctets.slice(4 - firstHostAddressOctetIndex).join(".")}.in-addr.arpa`;
    }
    const subnetMask = new Uint8Array(new Uint32Array([0xffffffff << (32 - cidr.prefixLength)]).buffer).reverse();
    const firstHostOctet = octets[firstHostAddressOctetIndex];
    if (firstHostOctet == null) {
        throw new Error("not found host octet");
    }
    const maskedOctets = new Uint8Array(4);
    for (let i = 0; i < 4; i++) {
        const octet = octets[i];
        if (octet == null) {
            throw new Error("not found octets");
        }
        const mask = subnetMask[i];
        if (mask == null) {
            throw new Error("not found subnet mask");
        }
        maskedOctets[i] = octet & mask;
    }
    const hostAddress = maskedOctets[firstHostAddressOctetIndex];
    if (hostAddress == null) {
        throw new Error("not found masked host address");
    }
    return `${hostAddress}-${cidr.prefixLength}.${reverseOctets.slice(4 - firstHostAddressOctetIndex).join(".")}.in-addr.arpa`;
}
function generateIPv6Rfc4183ReverseDnsName(cidr) {
    if (cidr.prefixLength < 8) {
        throw new Error("The notion of fewer than 8 mask bits is not reasonable."); // RFC 4183 4.1.4
    }
    const expandedAddress = expandIPv6Address(cidr.address);
    const nibbles = expandedAddress
        .split("")
        .filter((c) => c !== ":")
        .slice(0, Math.ceil(cidr.prefixLength / 4))
        .reverse(); // Nibbles, reversed
    return nibbles.join(".") + ".ip6.arpa";
}
// Helper function to expand a compressed IPv6 address (e.g., 2001:db8::1 -> 2001:0db8:0000:0000:0000:0000:0000:0001)
function expandIPv6Address(address) {
    const parts = address.split("::");
    const expandedParts = parts.map((part) => {
        const subParts = part.split(":");
        return subParts.map((subPart) => subPart.padStart(4, "0")).join(":");
    });
    const firstPart = expandedParts[0];
    if (firstPart == null) {
        throw new Error(`Missing ipv6 first part, got ${address}`);
    }
    if (parts.length === 2) {
        const secondPart = expandedParts[1];
        if (secondPart == null) {
            throw new Error(`Missing ipv6 second part, got ${address}`);
        }
        const missingSegments = 8 - (firstPart.split(":").length + secondPart.split(":").length);
        const padding = "0000:".repeat(missingSegments).slice(0, -1); // Add padding without trailing ':'
        return firstPart + ":" + padding + ":" + secondPart;
    }
    else {
        return firstPart;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmV2LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicmV2LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBS0Esb0RBbUJDO0FBeEJELHdDQUFxRDtBQUNyRCx3Q0FBa0U7QUFJbEUsU0FBZ0Isb0JBQW9CLENBQ2xDLElBQXlCLEVBQ3pCLGlCQUFvQztJQUVwQyxJQUFJLElBQUEsaUJBQVUsRUFBQyxJQUFJLENBQUMsRUFBRSxDQUFDO1FBQ3JCLE9BQU8saUNBQWlDLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDakQsQ0FBQztJQUNELElBQUksSUFBQSxpQkFBVSxFQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7UUFDckIsSUFDRSxFQUFFLEdBQUcsSUFBSSxDQUFDLFlBQVk7WUFDdEIsSUFBSSxDQUFDLFlBQVksR0FBRyxFQUFFO1lBQ3RCLGlCQUFpQixJQUFJLFNBQVMsRUFDOUIsQ0FBQztZQUNELE9BQU8saUNBQWlDLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDakQsQ0FBQzthQUFNLENBQUM7WUFDTixPQUFPLGlDQUFpQyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2pELENBQUM7SUFDSCxDQUFDO0lBQ0QsTUFBTSwyQkFBMkIsSUFBSSxFQUFFLENBQUM7QUFDMUMsQ0FBQztBQUVELFNBQVMsaUNBQWlDLENBQUMsSUFBYztJQUN2RCxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7SUFFbkQsTUFBTSxTQUFTLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsaUJBQWlCO0lBQzlDLElBQUksU0FBUyxJQUFJLElBQUksRUFBRSxDQUFDO1FBQ3RCLE1BQU0sSUFBSSxLQUFLLENBQUMsc0JBQXNCLENBQUMsQ0FBQztJQUMxQyxDQUFDO0lBRUQsTUFBTSxVQUFVLEdBQUcsVUFBVSxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUM7SUFDbkQsTUFB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QztJQUNuQyxJQUFJLFNBQVMsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUN0QixNQUFNLElBQUksS0FBSyxDQUFDLGdDQUFnQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO0lBQzdELENBQUM7SUFFRCxJQUFJLEtBQUssQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7UUFDdkIsTUFBTSxVQUFVLEdBQUcsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3BDLElBQUksVUFBVSxJQUFJLElBQUksRUFBRSxDQUFDO1lBQ3ZCLE1BQU0sSUFBSSxLQUFLLENBQUMsaUNBQWlDLE9BQU8sRUFBRSxDQUFDLENBQUM7UUFDOUQsQ0FBQztRQUNELE1BQU0sZUFBZSxHQUNuQixDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sR0FBRyxVQUFVLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ25FLE1BQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsbUNBQW1DO1FBQ2pHLE9BQU8sU0FBUyxHQUFHLEdBQUcsR0FBRyxPQUFPLEdBQUcsR0FBRyxHQUFHLFVBQVUsQ0FBQztJQUN0RCxDQUFDO1NBQU0sQ0FBQztRQUNOLE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSVB2NENpZHIsIGlzSVB2NENpZHIgfSBmcm9tIFwiLi4vdHlwZXMvaXB2NFwiO1xuaW1wb3J0IHsgSVB2NkFkZHJlc3MsIElQdjZDaWRyLCBpc0lQdjZDaWRyIH0gZnJvbSBcIi4uL3R5cGVzL2lwdjZcIjtcblxuZXhwb3J0IHR5cGUgUmV2ZXJzZURvbWFpbk1vZGUgPSBcIlJmYzIzMTdcIiB8IFwiUmZjNDE4M1wiO1xuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlUmV2ZXJzZURuc05hbWUoXG4gIGNpZHI6IElQdjRDaWRyIHwgSVB2NkNpZHIsXG4gIHJldmVyc2VEb21haW5Nb2RlOiBSZXZlcnNlRG9tYWluTW9kZSxcbik6IHN0cmluZyB7XG4gIGlmIChpc0lQdjZDaWRyKGNpZHIpKSB7XG4gICAgcmV0dXJuIGdlbmVyYXRlSVB2NlJmYzQxODNSZXZlcnNlRG5zTmFtZShjaWRyKTtcbiAgfVxuICBpZiAoaXNJUHY0Q2lkcihjaWRyKSkge1xuICAgIGlmIChcbiAgICAgIDI0IDwgY2lkci5wcmVmaXhMZW5ndGggJiZcbiAgICAgIGNpZHIucHJlZml4TGVuZ3RoIDwgMzIgJiZcbiAgICAgIHJldmVyc2VEb21haW5Nb2RlID09IFwiUmZjMjMxN1wiXG4gICAgKSB7XG4gICAgICByZXR1cm4gZ2VuZXJhdGVJUHY0UmZjMjMxN1JldmVyc2VEbnNOYW1lKGNpZHIpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gZ2VuZXJhdGVJUHY0UmZjNDE4M1JldmVyc2VEbnNOYW1lKGNpZHIpO1xuICAgIH1cbiAgfVxuICB0aHJvdyBgSW52YWxpZCBjaWRyIGJsb2NrLCBnb3QgJHtjaWRyfWA7XG59XG5cbmZ1bmN0aW9uIGdlbmVyYXRlSVB2NFJmYzIzMTdSZXZlcnNlRG5zTmFtZShjaWRyOiBJUHY0Q2lkcik6IHN0cmluZyB7XG4gIGNvbnN0IG9jdGV0cyA9IGNpZHIuYWRkcmVzcy5zcGxpdChcIi5cIikubWFwKE51bWJlcik7XG5cbiAgY29uc3QgbGFzdE9jdGV0ID0gb2N0ZXRzWzNdOyAvLyBUaGUgbGFzdCBvY3RldFxuICBpZiAobGFzdE9jdGV0ID09IG51bGwpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJub3QgZm91bmQgbGFzdCBvY3RldFwiKTtcbiAgfVxuXG4gIGNvbnN0IHN1Ym5ldE1hc2sgPSAweGZmZmZmZmZmIDw8IGNpZHIucHJlZml4TGVuZ3RoO1xuICBjb25zdCBob3N0QWRkcmVzcyA9IGxhc3RPY3RldCAmIH5zdWJuZXRNYXNrOyAvLyBFeHRyYWN0IGhvc3QgcGFydCBvZiBsYXN0IG9jdGV0LlxuXG4gIGNvbnN0IG5ldHdvcmtPY3RldHMgPSBvY3RldHMuc2xpY2UoMCwgMyk7XG4gIHJldHVybiBgJHtob3N0QWRkcmVzc30vJHtjaWRyLnByZWZpeExlbmd0aH0uJHtbLi4ubmV0d29ya09jdGV0c10ucmV2ZXJzZSgpLmpvaW4oXCIuXCIpfS5pbi1hZGRyLmFycGFgO1xufVxuXG5mdW5jdGlvbiBnZW5lcmF0ZUlQdjRSZmM0MTgzUmV2ZXJzZURuc05hbWUoY2lkcjogSVB2NENpZHIpOiBzdHJpbmcge1xuICBjb25zdCBvY3RldHMgPSBuZXcgVWludDhBcnJheShjaWRyLmFkZHJlc3Muc3BsaXQoXCIuXCIpLm1hcChOdW1iZXIpKTtcbiAgY29uc3QgcmV2ZXJzZU9jdGV0cyA9IFsuLi5vY3RldHNdLnJldmVyc2UoKTtcblxuICBpZiAoY2lkci5wcmVmaXhMZW5ndGggPCA4KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiVGhlIG5vdGlvbiBvZiBmZXdlciB0aGFuIDggbWFzayBiaXRzIGlzIG5vdCByZWFzb25hYmxlLlwiKTsgLy8gUkZDIDQxODMgNC4xLjRcbiAgfVxuXG4gIGNvbnN0IGZpcnN0SG9zdEFkZHJlc3NPY3RldEluZGV4ID0gTWF0aC50cnVuYyhjaWRyLnByZWZpeExlbmd0aCAvIDgpO1xuICBpZiAoY2lkci5wcmVmaXhMZW5ndGggJSA4ID09IDApIHtcbiAgICByZXR1cm4gYCR7cmV2ZXJzZU9jdGV0cy5zbGljZSg0IC0gZmlyc3RIb3N0QWRkcmVzc09jdGV0SW5kZXgpLmpvaW4oXCIuXCIpfS5pbi1hZGRyLmFycGFgO1xuICB9XG4gIGNvbnN0IHN1Ym5ldE1hc2sgPSBuZXcgVWludDhBcnJheShcbiAgICBuZXcgVWludDMyQXJyYXkoWzB4ZmZmZmZmZmYgPDwgKDMyIC0gY2lkci5wcmVmaXhMZW5ndGgpXSkuYnVmZmVyLFxuICApLnJldmVyc2UoKTtcbiAgY29uc3QgZmlyc3RIb3N0T2N0ZXQgPSBvY3RldHNbZmlyc3RIb3N0QWRkcmVzc09jdGV0SW5kZXhdO1xuICBpZiAoZmlyc3RIb3N0T2N0ZXQgPT0gbnVsbCkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIm5vdCBmb3VuZCBob3N0IG9jdGV0XCIpO1xuICB9XG5cbiAgY29uc3QgbWFza2VkT2N0ZXRzID0gbmV3IFVpbnQ4QXJyYXkoNCk7XG4gIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgaSsrKSB7XG4gICAgY29uc3Qgb2N0ZXQgPSBvY3RldHNbaV07XG4gICAgaWYgKG9jdGV0ID09IG51bGwpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIm5vdCBmb3VuZCBvY3RldHNcIik7XG4gICAgfVxuICAgIGNvbnN0IG1hc2sgPSBzdWJuZXRNYXNrW2ldO1xuICAgIGlmIChtYXNrID09IG51bGwpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIm5vdCBmb3VuZCBzdWJuZXQgbWFza1wiKTtcbiAgICB9XG4gICAgbWFza2VkT2N0ZXRzW2ldID0gb2N0ZXQgJiBtYXNrO1xuICB9XG5cbiAgY29uc3QgaG9zdEFkZHJlc3MgPSBtYXNrZWRPY3RldHNbZmlyc3RIb3N0QWRkcmVzc09jdGV0SW5kZXhdO1xuICBpZiAoaG9zdEFkZHJlc3MgPT0gbnVsbCkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIm5vdCBmb3VuZCBtYXNrZWQgaG9zdCBhZGRyZXNzXCIpO1xuICB9XG4gIHJldHVybiBgJHtob3N0QWRkcmVzc30tJHtjaWRyLnByZWZpeExlbmd0aH0uJHtyZXZlcnNlT2N0ZXRzLnNsaWNlKDQgLSBmaXJzdEhvc3RBZGRyZXNzT2N0ZXRJbmRleCkuam9pbihcIi5cIil9LmluLWFkZHIuYXJwYWA7XG59XG5cbmZ1bmN0aW9uIGdlbmVyYXRlSVB2NlJmYzQxODNSZXZlcnNlRG5zTmFtZShjaWRyOiBJUHY2Q2lkcik6IHN0cmluZyB7XG4gIGlmIChjaWRyLnByZWZpeExlbmd0aCA8IDgpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJUaGUgbm90aW9uIG9mIGZld2VyIHRoYW4gOCBtYXNrIGJpdHMgaXMgbm90IHJlYXNvbmFibGUuXCIpOyAvLyBSRkMgNDE4MyA0LjEuNFxuICB9XG5cbiAgY29uc3QgZXhwYW5kZWRBZGRyZXNzID0gZXhwYW5kSVB2NkFkZHJlc3MoY2lkci5hZGRyZXNzKTtcbiAgY29uc3QgbmliYmxlcyA9IGV4cGFuZGVkQWRkcmVzc1xuICAgIC5zcGxpdChcIlwiKVxuICAgIC5maWx0ZXIoKGMpID0+IGMgIT09IFwiOlwiKVxuICAgIC5zbGljZSgwLCBNYXRoLmNlaWwoY2lkci5wcmVmaXhMZW5ndGggLyA0KSlcbiAgICAucmV2ZXJzZSgpOyAvLyBOaWJibGVzLCByZXZlcnNlZFxuXG4gIHJldHVybiBuaWJibGVzLmpvaW4oXCIuXCIpICsgXCIuaXA2LmFycGFcIjtcbn1cblxuLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGV4cGFuZCBhIGNvbXByZXNzZWQgSVB2NiBhZGRyZXNzIChlLmcuLCAyMDAxOmRiODo6MSAtPiAyMDAxOjBkYjg6MDAwMDowMDAwOjAwMDA6MDAwMDowMDAwOjAwMDEpXG5mdW5jdGlvbiBleHBhbmRJUHY2QWRkcmVzcyhhZGRyZXNzOiBJUHY2QWRkcmVzcyk6IHN0cmluZyB7XG4gIGNvbnN0IHBhcnRzID0gYWRkcmVzcy5zcGxpdChcIjo6XCIpO1xuXG4gIGNvbnN0IGV4cGFuZGVkUGFydHMgPSBwYXJ0cy5tYXAoKHBhcnQpID0+IHtcbiAgICBjb25zdCBzdWJQYXJ0cyA9IHBhcnQuc3BsaXQoXCI6XCIpO1xuICAgIHJldHVybiBzdWJQYXJ0cy5tYXAoKHN1YlBhcnQpID0+IHN1YlBhcnQucGFkU3RhcnQoNCwgXCIwXCIpKS5qb2luKFwiOlwiKTtcbiAgfSk7XG5cbiAgY29uc3QgZmlyc3RQYXJ0ID0gZXhwYW5kZWRQYXJ0c1swXTtcbiAgaWYgKGZpcnN0UGFydCA9PSBudWxsKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBNaXNzaW5nIGlwdjYgZmlyc3QgcGFydCwgZ290ICR7YWRkcmVzc31gKTtcbiAgfVxuXG4gIGlmIChwYXJ0cy5sZW5ndGggPT09IDIpIHtcbiAgICBjb25zdCBzZWNvbmRQYXJ0ID0gZXhwYW5kZWRQYXJ0c1sxXTtcbiAgICBpZiAoc2Vjb25kUGFydCA9PSBudWxsKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE1pc3NpbmcgaXB2NiBzZWNvbmQgcGFydCwgZ290ICR7YWRkcmVzc31gKTtcbiAgICB9XG4gICAgY29uc3QgbWlzc2luZ1NlZ21lbnRzID1cbiAgICAgIDggLSAoZmlyc3RQYXJ0LnNwbGl0KFwiOlwiKS5sZW5ndGggKyBzZWNvbmRQYXJ0LnNwbGl0KFwiOlwiKS5sZW5ndGgpO1xuICAgIGNvbnN0IHBhZGRpbmcgPSBcIjAwMDA6XCIucmVwZWF0KG1pc3NpbmdTZWdtZW50cykuc2xpY2UoMCwgLTEpOyAvLyBBZGQgcGFkZGluZyB3aXRob3V0IHRyYWlsaW5nICc6J1xuICAgIHJldHVybiBmaXJzdFBhcnQgKyBcIjpcIiArIHBhZGRpbmcgKyBcIjpcIiArIHNlY29uZFBhcnQ7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGZpcnN0UGFydDtcbiAgfVxufVxuIl19